# List of plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'oluevaera/tmux-conda-inherit'

# theming
set -g @plugin 'dracula/tmux'

# better copying in copy mode
set -g @plugin 'tmux-plugins/tmux-yank'

set -g @plugin 'joshmedeski/tmux-nerd-font-window-name'


# Set default shell to zsh
set -g default-shell /bin/zsh

# Enable Vim-like key bindings for tmux
# turn on scrolling
set -g mouse on

# set new prefix
# unbind C-b
# set -g prefix C-a
# bind C-a send-prefix
unbind C-b
set -g prefix C-z
bind C-z send-prefix


# Smart pane switching with awareness of Vim splits.
# See: https://github.com/christoomey/vim-tmux-navigator
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|l?n?vim?x?|fzf)(diff)?$'"
bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h'  'select-pane -L'
bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j'  'select-pane -D'
bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k'  'select-pane -U'
bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l'  'select-pane -R'
tmux_version='$(tmux -V | sed -En "s/^tmux ([0-9]+(.[0-9]+)?).*/\1/p")'
if-shell -b '[ "$(echo "$tmux_version < 3.0" | bc)" = 1 ]' \
    "bind-key -n 'C-\\' if-shell \"$is_vim\" 'send-keys C-\\'  'select-pane -l'"
if-shell -b '[ "$(echo "$tmux_version >= 3.0" | bc)" = 1 ]' \
    "bind-key -n 'C-\\' if-shell \"$is_vim\" 'send-keys C-\\\\'  'select-pane -l'"

bind-key -T copy-mode-vi 'C-h' select-pane -L
bind-key -T copy-mode-vi 'C-j' select-pane -D
bind-key -T copy-mode-vi 'C-k' select-pane -U
bind-key -T copy-mode-vi 'C-l' select-pane -R
bind-key -T copy-mode-vi 'C-\' select-pane -l
bind-key -T copy-mode-vi J send-keys -X -N 10 scroll-down
bind-key -T copy-mode-vi K send-keys -X -N 10 scroll-up


# make prefix + n open a new window in the same dir
unbind c
bind n new-window -a -c "#{pane_current_path}"

# (optional) same for splits
unbind %
bind i split-window -h -c "#{pane_current_path}"
unbind '"'
bind s split-window -v -c "#{pane_current_path}"

# window controls
bind h previous-window
bind l next-window
bind o last-window
set -g base-index 1
set -g renumber-windows on

# Let applications (like Claude Code) set window titles via escape sequences
set -g allow-passthrough on
set -g allow-rename on
set -g set-titles on

# Alt+number to switch windows (no prefix needed)
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9
bind -n M-0 select-window -t 0

# Alt+o/h/l/n for window navigation (no prefix needed)
bind -n M-o last-window
bind -n M-h previous-window
bind -n M-l next-window
bind -n M-n new-window -a -c "#{pane_current_path}"
bind -n M-w confirm-before -p "Kill window #W? (y/n)" kill-window

# Alt+Shift+h/l to move window left/right (no prefix needed)
bind -n M-H swap-window -t -1 \; previous-window
bind -n M-L swap-window -t +1 \; next-window

# 3D navigation: sessions as vertical stack (M-j/M-k)
# No wraparound - stops at top/bottom
bind -n M-k if-shell '[ "$(tmux list-sessions -F "##S" | head -1)" = "$(tmux display -p "##S")" ]' '' 'switch-client -p'
bind -n M-j if-shell '[ "$(tmux list-sessions -F "##S" | tail -1)" = "$(tmux display -p "##S")" ]' '' 'switch-client -n'
bind -n M-O switch-client -l  # last session (like M-o for last window)

# M-J/M-K to swap session order
bind -n M-J run-shell 'cur="#S"; n="${cur%%-*}"; name="${cur#*-}"; next=$((n+1)); other=$(tmux list-sessions -F "##S" | grep "^$next-" | head -1); [ -z "$other" ] && exit 0; oname="${other#*-}"; tmux rename-session -t "$other" "0-tmp"; tmux rename-session "$next-$name"; tmux rename-session -t "0-tmp" "$n-$oname"'
bind -n M-K run-shell 'cur="#S"; n="${cur%%-*}"; name="${cur#*-}"; [ "$n" -le 1 ] && exit 0; prev=$((n-1)); other=$(tmux list-sessions -F "##S" | grep "^$prev-" | head -1); [ -z "$other" ] && exit 0; oname="${other#*-}"; tmux rename-session -t "$other" "0-tmp"; tmux rename-session "$prev-$name"; tmux rename-session -t "0-tmp" "$n-$oname"'



# Session management (matches window pattern: M-n/M-N, M-w/M-W)
# M-N: new session with number prefix (1-name, 2-name, etc.)
bind -n M-N run-shell 'num=$(($(tmux list-sessions | wc -l) + 1)); name="${num}-$(basename "#{pane_current_path}")"; tmux new-session -d -s "$name" -c "#{pane_current_path}" && tmux switch-client -t "$name"'
bind -n M-W confirm-before -p "Kill session #S? (y/n)" kill-session  # close session
# M-r: rename session but keep number prefix
bind -n M-r display-popup -E -w 40 -h 3 'bash -c "num=\$(tmux display -p \"#S\" | cut -d- -f1); read -p \"Rename: \" name; tmux rename-session \"\$num-\$name\""'

# When session is destroyed, switch to another instead of detaching
set -g detach-on-destroy off

# Renumber sessions on close (keeps order clean)
set-hook -g session-closed 'run-shell "tmux list-sessions -F \"##S\" | awk \"{print NR, \\\$1}\" | while read i s; do name=\${s##*-}; tmux rename-session -t \"\$s\" \"\$i-\$name\" 2>/dev/null; done"'

# Rename "default" session to "1-main" on startup
if-shell 'tmux has-session -t default 2>/dev/null' 'rename-session -t default 1-main'

# Session picker (native menu - press number to select, q to close)
bind -n M-s run-shell 'tmux list-sessions -F "##S" | awk "BEGIN {ORS=\" \"} {name=\$1; sub(/^[0-9]+-/, \"\", name); print name, NR, \"\\\"switch-client -t \" \$1 \"\\\"\"}" | xargs tmux display-menu -T "Sessions"'



# put bar on bottom
set -g status-position bottom
set -g status on


# fix colors
set -ga terminal-overrides ",xterm-256color:Tc"


# theming (dracula/tmux)
# https://github.com/dracula/tmux
set -g @dracula-show-powerline true
set -g @dracula-show-left-icon "λ  #S"
set -g @dracula-plugins "mac-player git network-vpn battery time"
set -g @dracula-mac-player-remote true
set -g @dracula-mac-player-app "Spotify"
set -g @dracula-mac-player-length 50
set -g @dracula-mac-player-remote-play-pause "Space"
set -g @dracula-mac-player-remote-back ","
set -g @dracula-mac-player-remote-next "."
set -g @dracula-git-disable-status true
set -g @dracula-git-show-current-symbol ""
set -g @dracula-show-timezone false
set -g @dracula-battery-label false

set -g @dracula-colors "
# simple gruvbox Color Pallette
white='#EBDBB2'
gray='#32302F'
dark_gray='#282828'
light_purple='#B16286'
dark_purple='#504945'
cyan='#689D6A'
green='#98971A'
orange='#D65D0E'
red='#CC241D'
pink='#D3869B'
yellow='#D79921'
"

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'
